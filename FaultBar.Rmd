---
title: "Crow Fault Bars"
author: "Justin Mann"
date: "2024-10-04"
output: html_document
---

```{r libraries}
library(tidyverse) 
library(lme4)
library(nnet)
library(broom)
library(glmmTMB)
library(MCMCglmm)
theme_set(theme_classic())
```


```{r import longform data}
fb.df <- read.csv("FaultBarData.csv", h=T)
fb.df$Length <- as.numeric(fb.df$Length)
fb.df$Habitat <- as.factor(fb.df$Habitat)
fb.df <- fb.df %>% drop_na(Grade, Habitat, Length)
fb.df$Grade <- as.factor(fb.df$Grade)
fb.df$Feather <- as.factor(fb.df$Feather)
```


```{r Length Scatter Plot}
range(fb.df$Length)
plot(fb.df$Length)
```

```{r Length Histogram}
hist(fb.df$Length)
```

```{r scaling length}
fb.df$LengthScaled <- scale(fb.df$Length)
```

```{r fb length scaled histogram}
hist(fb.df$LengthScaled)
```


```{r import short form data}
fbs.df <- read.csv("FeatherMaster_1Nov24.csv", h=T)
fbs.df <- fbs.df[,1:15]
fbs.df$ID <- as.factor(fbs.df$ID)
n_occur <- data.frame(table(fbs.df$ID))
n_occur[n_occur$Freq > 1,]#no repeat IDs
fbs.df$LightPlusMedium <- fbs.df$LightBars + fbs.df$MediumBars #a column combining light and medium bars
```


### Sums of light fault bars in urban and rural habitats
```{r Light fb sums by habitat}
sum(fbs.df$LightBars[fbs.df$Habitat=="urban"]) #200 urban light bars
sum(fbs.df$LightBars[fbs.df$Habitat=="rural"]) #300 rural light bars
```




### Gausian linear model for light fault bars. 
This model uses a Gaussian probability distribution which is not appropriate for count data.
```{r light fb gaussian mdl}
summary(lm(data = fbs.df, LightBars ~ Habitat))
```

### Poisson model for light fault bars.
This model uses the poisson probability distribution which is appropriate for count data. 
There are significantly fewer light fault bars in the urban habitat.
```{r light fb poisson mdl}
light.poisson.mdl <- (glm(data = fbs.df, LightBars ~ Habitat, family = "poisson"))
summary(light.poisson.mdl)
```

### Zero inflation test
This code confirms that the data are zero inflated.
The output states that ~40% of the observed data are zeros, while the poisson model only expects ~7% of the data points to be zeros. 
```{r zero inflation test}
#zero inflation test from: http://data.princeton.edu/wws509/r/overdispersion.html 
zobs <- fbs.df$LightBars == 0
zpoi <- exp(-exp(predict(light.poisson.mdl)))
c(obs=mean(zobs), poi = mean(zpoi))
```


### Zero-inflated poisson model
This model accounts for the zero inflated data. There are still significantly fewer light fault bars in the urban habitat.
```{r light fb ZIP mdl}
summary(glmmTMB(data = fbs.df, LightBars ~ Habitat, ziformula = ~1, family = "poisson"))
```

### Light fault bar density plot
This plot shows the frequency of light fault bar numbers per feather in the urban and rural samples. The dotted lines are the habitat means.
```{r light fb density plot}
mean(fbs.df$LightBars[fbs.df$Habitat=="urban"])
mean(fbs.df$LightBars[fbs.df$Habitat=="rural"])

Habitat <- c("Urban", "Rural")
Means <- c(2.27, 3.3)
HabitatMeans <- data.frame(Habitat,Means)

LightBarDensity.plot <- ggplot(fbs.df, aes(x=LightBars, fill = Habitat))+
  geom_density(alpha=0.5)+
  geom_vline(data = HabitatMeans, aes(xintercept = Means, color=Habitat),
             linetype="dashed",
             size = 1,
             show.legend = FALSE)+
  scale_fill_manual(values = c("#D95F02", "#1B9E77"))+
  ylab("Frequency")+
  xlab("Number of light fault bars")

LightBarDensity.plot
```


### Sum of medium fault bars in urban and rural habitats
```{r sum of medium fb per habitat}
sum(fbs.df$MediumBars[fbs.df$Habitat=="urban"])
sum(fbs.df$MediumBars[fbs.df$Habitat=="rural"])
```


### Poisson model for medium fault bars
This model shows significantly fewer medium fault bars in the urban habitat
```{r medium fb poisson mdl}
summary(glmmTMB(data = fbs.df, MediumBars ~ Habitat, family = "poisson"))
```


### Zero-inflated poisson model for medium fault bars
For some unknown reason, this model no longer shows a significant relationship. NEED TO INVESTIGATE!
```{r medium fb ZIP mdl}
summary(glmmTMB(data = fbs.df, MediumBars ~ Habitat, ziformula=~1, family = "poisson"))
```


### Sum of strong fault bars in urban and rural habitats
```{r sum of strong fb per habitat}
sum(fbs.df$StrongBars[fbs.df$Habitat=="urban"])
sum(fbs.df$StrongBars[fbs.df$Habitat=="rural"])
```


### Poisson model for strong fault bars
This model shows a trend towards more strong fault bars in the urban habitat, but the relationship is non significant. The proportional difference is similar, but the strong bar sample is smaller.
```{r strong fb poisson mdl}
summary(glmmTMB(data = fbs.df, StrongBars ~ Habitat, family = "poisson"))
```

### Zero-inflated poisson model for strong fault bars
```{r strong fb ZIP mdl}
summary(glmmTMB(data = fbs.df, StrongBars ~ Habitat, ziformula = ~1, family = "poisson"))
```


### Zero-inflated poisson model for total number of fault bars
Overall, there are significantly fewer total fault bars in the urban habitat sample.
```{r total fb ZIP mdl}
summary(glmmTMB(data = fbs.df, BarsTotal ~ Habitat, ziformula = ~1, family = "poisson"))
```


### Total fault bar density plot
This plot shows the frequency of total fault bar numbers per feather in the urban and rural samples. The dotted lines are the habitat means.
```{r}
mean(fbs.df$BarsTotal[fbs.df$Habitat=="urban"])
mean(fbs.df$BarsTotal[fbs.df$Habitat=="rural"])

TotHabitat <- c("Urban", "Rural")
TotMeans <- c(3.83, 5.42)
TotHabitatMeans <- data.frame(TotHabitat,TotMeans)

TotalBarDensity.plot <- ggplot(fbs.df, aes(x=BarsTotal, fill = Habitat))+
  geom_density(alpha=0.5)+
  geom_vline(data = HabitatMeans, aes(xintercept = TotMeans, color=TotHabitat),
             linetype="dashed",
             size = 1,
             show.legend = FALSE)+
  scale_fill_manual(values = c("#D95F02", "#1B9E77"))+
  ylab("Frequency")+
  xlab("Total number of fault bars")

TotalBarDensity.plot
```

#1. Restrict by feather type (DONE)
#  - Total fault bars
#  - Medium fault bars

#2. Combine light and medium fault bars

#3. Feather weight by Habitat for feather type

#4. Length of fault bar by Habitat


### Subsetting by feather type
```{r primary df subset}
fbs.prim.df <- subset(fbs.df, Type == "primary")
```


```{r primary light fb poisson mdl}
prim.light.poisson.mdl <- glmmTMB(data = fbs.prim.df, LightBars ~ Habitat, family = "poisson")
summary(prim.light.poisson.mdl)
```


```{r primary light zero inflation test}
#zero inflation test from: http://data.princeton.edu/wws509/r/overdispersion.html 
zobs <- fbs.prim.df$LightBars == 0
zpoi <- exp(-exp(predict(prim.light.poisson.mdl)))
c(obs=mean(zobs), poi = mean(zpoi))
```


```{r primary light fb ZIP mdl}
prim.light.ZIP.mdl <- glmmTMB(data = fbs.prim.df, LightBars ~ Habitat, ziformula = ~1, family = "poisson")
summary(prim.light.ZIP.mdl)
```


```{r primary medium fb mdl}
summary(glmmTMB(data = fbs.prim.df, MediumBars ~ Habitat, family = "poisson"))
```

```{r secondary df subset}
fbs.sec.df <- subset(fbs.df, Type == "secondary")
```


```{r secondary light fb mdl}
summary(glmmTMB(data = fbs.sec.df, LightBars ~ Habitat, ziformula = ~1, family = "poisson"))
```


```{r secondary medium fb mdl}
summary(glmmTMB(data = fbs.sec.df, MediumBars ~ Habitat, family = "poisson"))
```


```{r tail df subset}
fbs.tail.df <- subset(fbs.df, Type == "tail")
```


```{r tail light fb ZIP mdl}
summary(glmmTMB(data = fbs.tail.df, LightBars ~ Habitat, ziformula = ~1, family = "poisson"))
```


```{r tail medium fb mdl}
summary(glmmTMB(data = fbs.tail.df, MediumBars ~ Habitat, ziformula = ~1, family = "poisson"))
```